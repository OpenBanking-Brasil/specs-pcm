title Fluxo de Consentimento

participant Usuário

participant Iniciadora/Receptora

participant PCM

participant Detentora/Transmissora

Usuário->Iniciadora/Receptora: Confirma o consentimento

Iniciadora/Receptora->Detentora/Transmissora: POST /consents

Iniciadora/Receptora->PCM:Report do POST /consents da iniciadora/receptora

Detentora/Transmissora->PCM:Reporte do POST /consents da detentora/transmissora

Iniciadora/Receptora->Usuário: Comanda REDIRECT

Iniciadora/Receptora->PCM:POST /report-api/v2/hybrid-flow/client/redirect-to-server



Usuário->Detentora/Transmissora:Redirecionamento Hybrid Flow

Detentora/Transmissora->PCM:POST /report-api/v2/hybrid-flow/server/redirect-target

note right of Detentora/Transmissora:Se handoff, teremos x Report 1.1.\ntipo: (AWAITING_HANDOFF, AWAITING_AUTH, AWAITING_REDIRECT_TO_APP)

Usuário->Detentora/Transmissora: Realiza autenticação

Detentora/Transmissora->PCM:POST /report-api/v2/hybrid-flow/server/authenticated

Usuário->Detentora/Transmissora: Cliente aprovou/rejeitou o consentimento

Detentora/Transmissora->PCM:POST /report-api/v2/hybrid-flow/server/redirect-to-client

Detentora/Transmissora->Usuário:Redirect para URL de Callback (authorization_code|error_code)

Usuário->Iniciadora/Receptora:Redirect(authorization_code, error_code)

Iniciadora/Receptora->Iniciadora/Receptora:captura auth_code

Iniciadora/Receptora->PCM:Se tiver erro:\n - POST /report-api/v2/hybrid-flow/client/redirect-target-with-errors\n\nSenão:\n - POST /report-api/v2/hybrid-flow/client/redirect-target-without-errors\n


Iniciadora/Receptora->Detentora/Transmissora:POST /token (auth_code por access_token e refresh_token)

Iniciadora/Receptora->PCM:Reporte do POST /token (consentId)



note over PCM:hybrid-flow/client/redirect-to-server\n{\nconsentId,\nuriAuthorizationEndpoint, \nplataform,\nosVersion\n}\n\nhybrid-flow/server/redirect-target\n{\nconsentId,\nplatform,\nosVersion\ntype: (AWAITING_HANDOFF, AWAITING_USER_AUTH, AWAITING_REDIRECT_TO_APP)\n}\n\nhybrid-flow/server/authenticated\n{\nconsentId,\nplataforma,\nos_version\n}\n\nhybrid-flow/server/redirect-to-client\n{\nconsentId,\nuri_callback, \nplataforma,\nos_version,\ntype (AUTHORISED, REJECTED)* referenciar GET da /consents\n}\n\nhybrid-flow/client/redirect-target-with-errors\n{\nconsentId,\nplatform,\nos_version\nerror\n}\n\nhybrid-flow/client/redirect-target-without-errors\n{\nconsentId,\nplatform,\nos_version\n}
